# malware-finder - a Volatility wrapper script

A shitty but somewhat useful Python script which acts as a wrapper for
[Volatility](https://github.com/volatilityfoundation/volatility) and is able to
correlate the output of Volatility plugins such as malfind, vadlist, apihooks,
ldrmodules etc.

Obviously it would've been better to write plugins for Volatility directly
instead, but using Volatility on the command line without a wrapper is annoying
and cumbersome.

## Features

* **Correlation look-up**: analyze the output of Volatility's malfind, vadlist,
apihooks, ldrmodules etc. and look for correlations.

* **VirusTotal**: scan processes or DDLs directly with VirusTotal.

* **Caching**: a cache file is created for each Volatility operation per image
(based on the Volatility arguments and on a checksum of the image's content).
This way each Volatility command only needs to be executed once per image.

* **History**: for each image (based on a checksum of the image's content) a
command history is created.

## Further stuff to implement

* ~~Implement VirusTotal scanner~~
* ~~Save history per image based on image hash~~
* ~~Configuration file to store Volatility path & VT API key etc. & config dir param~~
* ~~Make colors work on Windows (https://pypi.python.org/pypi/colorama)~~
* ~~Storage configuration file in %APPDATA%/malware-finder/config.ini on Windows (see https://gist.github.com/grawity/1427281)~~
* Cache builder: cache most common Volatility commands for all specified images
* Make VirusTotal uploads possible for unlinked processes and specific memory areas
* Cache results of VirusTotal
* Scanning all processes or all DLLs of a process using VirusTotal

## Dependencies

* Python 3.4+

Recommended optional dependencies:

* `readline` (`pyreadline` on Windows) - command line navigation and history
* `requests` - used for scanning using VirusTotal
* `colorama` - colored output

## Configuration

Configuration is stored in an INI-style file in the section "[DEFAULT]" at the
following location:

* Windows: `%APPDATA%\malware-finder/config.ini`
* Other: `~/.malware-finder/config.ini`, where `~` expands to your user's home directory.

The following configuration options are available:

* `volatility`
* `cache`
* `dump`
* `profile`
* `vt_api_key`
* `vt_workers`

Options specified in the configuration file are used as default values and will
be overwritten by any options specified on the command line.

### Windows

Create the file `%APPDATA\malware-finder\config.ini` with the following content:

```ini
[DEFAULT]
volatility = PATH_TO_YOUR_VOLATILITY_EXECUTABLE
vt_api_key = YOUR_VIRUSTOTAL_API_KEY
```

### UNIX-like systems

```bash
cat <<'EOF' > ~/.malware-finder/config.ini
[DEFAULT]
volatility = PATH_TO_YOUR_VOLATILITY_EXECUTABLE
vt_api_key = YOUR_VIRUSTOTAL_API_KEY
EOF
```

## Usage

```
usage: malware-finder.py [-h] [-C CONFIG_FILE] [-v VOLATILITY] [-c CACHE]
                         [-d DUMP] [-p PROFILE] [-a VT_API_KEY]
                         [-w VT_WORKERS]
                         image

positional arguments:
  image                 Path to the image to analyze

optional arguments:
  -h, --help            show this help message and exit
  -C CONFIG_FILE, --config-file CONFIG_FILE
                        Path to the configuration file
  -v VOLATILITY, --volatility VOLATILITY
                        Path to the volatility executable (default: volatility)
  -c CACHE, --cache CACHE
                        Path to the caching directory (default: cache)
  -d DUMP, --dump DUMP  Path where to drop binary dumps (default: dump)
  -p PROFILE, --profile PROFILE
                        Image's volatility profile
  -a VT_API_KEY, --vt-api-key VT_API_KEY
                        VirusTotal API key
  -w VT_WORKERS, --vt-workers VT_WORKERS
                        Amount of VirusTotal workers (default: 4)
```

## FAQ (Fukkin Annoyin Questionz)
### sir plz halp, me no haz ViruzTotalz api key, where i can haz such key?

Go to https://www.virustotal.com/ and register an account. Once you manage to
log yourself in, go to
https://www.virustotal.com/en/user/<YOU_USERNAME_HERE>/apikey/ and bam, you're
done buddy! Thank u, come again.

## Usage example

```
$ ./malware-finder.py images/image07.raw
SHA512 checksum: 0b290970eb65043e99310575f10585d4868cc4cd5234dcabbde891cf02a29e8dd218fa9f72f7ebce0a6e04125143a5bc04d90cb837b70bd2a8f9cbc2ca482fe4
Testing profile "Win7SP0x86"
Profile: Win7SP0x86
image07.raw> help
Internal commands:
* apihooks
* correlate
* dlllist
* evildll
* evilps
* hollow
* identify
* imageinfo
* ldrmodules
* malfind
* printkey_autostart
* pslist
* psxview
* strings
* vadinfo
* vt
image07.raw> :vt -p 1820
Executing "procdump --dump-dir=dump --pid=1820"
Uploading "dump/executable.1820.exe" (2.5 MiB) to VirusTotal
Detection rate: 2/56 (3%)
Scan date: 2017-01-28 15:11:16
URL: https://www.virustotal.com/file/e63ff30937f5ed6ecabea5d41338407dfb7d18e8a34347f48a2da4dd5a619530/analysis/1485616276/

Amount Malware
     1 HEUR/QVM10.1.0000.Malware.Gen
     1 malicious_confidence_89% (D)
image07.raw> :vt -p 2180 -a 1638400
Executing "dlldump --dump-dir=dump --pid=2180 --base=1638400"
Uploading "dump/module.2180.3fd9da58.190000.dll" (30.5 KiB) to VirusTotal
Detection rate: 3/57 (5%)
Scan date: 2017-01-28 15:30:37
URL: https://www.virustotal.com/file/a0a297b2b5d1089dc2c70674727e0a3ccecf3fd582a171562dacbc548622bbe1/analysis/1485617437/

Amount Malware
     1 HEUR/QVM40.1.0000.Malware.Gen
     1 malicious_confidence_84% (D)
     1 Packed.CPEX-based.cda
image07.raw> 
```
